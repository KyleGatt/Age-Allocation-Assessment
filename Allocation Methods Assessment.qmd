---
title: "Allocation Methods Assessment"
author: "Kyle Gatt"
format: html
editor: visual
theme: journal
---

```{r, echo=F, include=F}
library(dplyr)
library(tidyr)
library(zoo)
library(scales)
library(forecast)
library(tseries)
library(TTR)
library(Metrics)
library(ggplot2)
library(purrr)
library(flextable)
library(DT)
library(lubridate)
library(TSrepr)
library(gghighlight)
library(tidyverse)
```

# Background

Stock allocation methods for commercially harvested sockeye salmon in Upper Cook Inlet (UCI) have varied over the years. From 1976 to 1998, scale pattern analysis was the primary stock allocation method but proved unreliable. In 1999, a weighted age allocation model was introduced (see Tobias and Willette 2013 for details) but later replaced in 2005 with genetic stock identification (GSI). The age allocation model remains the primary source for inseason (July to January) stock specific harvest estimates but are replaced post-season with GSI estimates for brood table development. Late-run Kenai River sockeye salmon estimates derived from the age allocation model are used inseason to inform the Kenai River sockeye salmon inriver escapement goal under 5 AAC 21.360 of the *Kenai River Late-Run Sockeye Salmon Management Plan*.

Performance of the age allocation model has not been readily tracked over time since its initial development. Though the model has proven as a valuable tool for generating inseason stock specific harvest estimates, this approach requires large sample sizes and time sensitive age composition data. Due to funding and staffing challenges, alternative methods of inseason stock apportionment need to be explored. Thus, objective of this analysis is to three fold:

1.  *Assess the performance of the age allocation model for generating inseason stock-specific harvest estimates.*
2.  *Explore alternative methods to the age allocation model that utilize historical GSI data for generating inseason stock-specific harvest estimates.*
3.  *Assess the performance of alternative stock allocation methods for the inseason run-tier assessment of late-run Kenai River sockeye salmon.*

# Methods

### Age Allocation Data

In general, the age allocation model uses the relative contribution of an age class in a stock's escapement to represent the relative contribution of that age class in the commercial harvest for a specific time and area (fishery strata) fished. Each fishery has an assumed stock composition to represent the overall harvest which is based on a stock's proximity to a fishery (Table 1). Timely inseason age composition data from both the commercial harvests and escapements are required to inform the model. However, since the model's initial development several of the primary stock assessment projects that contributed age composition data of escapements are no longer operational. Several stop gaps have been developed over the years to continue running the model. For example, the Susitna and Fish Creek stocks rely on pre-season forecasts of age compositions to these systems for allocation. Additionally, the Crescent River stock uses the age composition of the Westside harvest.

Although the age allocation model approach has been used to generate stock-specific harvest estimates in Upper Cook Inlet since 1999, stock- and fishery-specific results were only available for years spanning 2017 to 2024 for this analysis. Additionally, the age allocation model analysis was performed in excel and only provided point estimates for each day the analysis was run.

Table 1.- Assumed stock composition of for each harvest group in the age allocation model.

```{r, echo=F, message=FALSE, warning=F}

# Import Age Allocation Results 
AgeAllocation<-read.csv(file("C:/Users/kpgatt/OneDrive - State of Alaska/Documents/GitHub/Age-Allocation-Assessment/Data/AgeAllocationPerformance.csv"))   

AgeAllocation%>%filter(Allocation>0)%>%
  group_by(Fishery)%>%summarize(Stock=unique(Stock))%>%   
  group_by(Fishery)%>%summarize(Stock=paste(Stock, collapse = ", "))%>%   
  flextable()%>%   theme_apa()%>%   
  line_spacing(space = 1,part = "all")%>%   
  align(j=1,align="left", part = "all")%>%   
  align(j=2,align="left", part = "all")%>%   
  set_header_labels(values = c("Area Strata", "Stock"))%>%   
  fix_border_issues()%>%   autofit()

```

### Genetic Stock Identification Data

Fishery-specific genetic stock identification estimates spanning 2005 to 2024 were complied from various reports (Barclay, A. W., 2020; Barclay and Chenoweth 2021; Barclay 2024; A. W. Barclay, Fishery Biologist, Alaska Department of Fish and Game, Anchorage, personal communication) into a centralized dataframe for further analysis. The fisheries sampled for GSI analyses have varied over the time series but have generally consisted of four major strata including: Central District Drift, Central District Set Gillnet (ESSN), Northern District, and Westside. When applicable, the average of corridors only and non-corridor GSI estimates were used to represent the Drift gillnet area strata to ensure comparability with age allocation model results (the age allocation model does not treat these fisheries independently). Furthermore, the average of Kalgin Island and Westside GSI estimates were used to represent the Westside area strata because these fisheries are often reported as an aggregate due to low sample sizes and the inability to ensure pure mixtures among these fisheries. Primary stocks represented in GSI analyses include Kenai, Kasilof, Crescent, Susitna rivers, Fish Creek, West Cook Inlet (West), and Knik/Turnagain/Northeast Cook Inlet (KTNE). Genetic stock identification estimates for the West and KTNE reporting groups were aggregated to represent "other" stocks in comparative analyses with age allocation model results.

```{r, echo=F, message=F}
GSI<-read.csv(file("C:/Users/kpgatt/OneDrive - State of Alaska/Documents/GitHub/Age-Allocation-Assessment/Data/GSI.Aggregated.csv"))%>%
  mutate(Stock=ifelse(Stock%in%"KTNE" | Stock%in%"West","Other",Stock))%>%
  group_by(Year, Fishery,Stock)%>%summarize(Comp=sum(Comp))
```

```{r, echo=F, message=FALSE, warning=F}
GSI%>%ggplot()+
  geom_bar(aes(Year,round(Comp,digits=2),fill=Stock),stat="identity")+
  facet_grid(Fishery~.)+
  theme_bw()+
  ylab("Proportion of harvest")+
  xlab("")+
  theme(text = element_text(family = "serif")) 

```

Figure 1.- Historical GSI estimates for primary sampled fisheries, 2005 to 2024.

### Commercial Harvest Data

Harvest data was exported from OceanAk's Statewide Salmon Fishticket database as annual totals of sockeye salmon harvest by statistical area using the following filters: Management Unit Code == "UCI", Harvest Code /= "21; 22 ;23 ;24; 41; 42; 43", Species Code == 420, Batch year is between 2005 and 2024. Annual totals were then assigned to fishery strata based on statistical area and gear code (Table 2). Once assigned to a fishery, statistical area harvest totals were summed by year for fishery specific annual grand totals (Figure 2).

Table 1.- Statistical areas included within each fishery stratum.

```{r, echo=F, message=FALSE, warning=F}
Harvest<-read.csv(file("C:/Users/kpgatt/OneDrive - State of Alaska/Documents/GitHub/Age-Allocation-Assessment/Data/Upper Cook Inlet Historical Harvest.csv"))%>%rename("Year"=Batch.Year)%>%
  mutate(Fishery=ifelse(Stat.Area%in%c(24741,24742,24743,24710,24720,24730,24790,24780,24770),"Northern District",
                               ifelse(Stat.Area%in%c(24510,24520,24530,24540,24550,24555,24560,24610,24620)&Gear.Code==4,"Westside",
                                             ifelse(Stat.Area%in%c(24442,24441,24432,24431,24422,24421),"ESSN",
                                                                  ifelse(Gear.Code==3,"Central District Drift","Error")))))%>%
  filter(!Fishery%in%"Error")

# SummarizeHarvest dat
Harvest.Sum<-Harvest%>%group_by(Year,Fishery)%>%summarize(Harvest=sum(Number.Of.Animals..sum.))


Harvest%>%group_by(Fishery)%>%summarize(Stat.Area=as.factor(unique(Stat.Area)))%>%
  group_by(Fishery)%>%summarize(Stat.Area=paste(Stat.Area, collapse = ", "))%>%
  flextable()%>%
  theme_apa()%>%
  line_spacing(space = 1,part = "all")%>%
  align(j=1,align="left", part = "all")%>%
  align(j=2,align="left", part = "all")%>%
  set_header_labels(values = c("Fishery Strata", "Statistical area"))%>%
  fix_border_issues()%>%
  autofit()
```

```{r, echo=F, message=FALSE, warning=F}

Harvest.Sum%>%
  ggplot()+
  geom_bar(aes(Year,Harvest, fill=Fishery), stat="identity")+
  theme_classic()+
  scale_y_continuous(labels = comma)+
  labs(fill='Fishery strata')+
  ylab("Total Harvest")+
  xlab("")+
  theme(text = element_text(family = "serif")) 

```

Figure 2.- Harvest totals by fishery strata, 2005 to 2024.

### Data Analysis

Age allocation model performance was assessed for each stock across all fisheries and years using coefficient of variation (CV) between GSI and age allocation stock compositions. Coefficient of variation was chosen over other metrics as to ensure a meaningful zero value for fisheries in which the age allocation model did not assume the full compliment of stock composition. Prior to estimating CV values, GSI and harvest datasets were truncated to years spanning 2017 to 2024 to ensure comparable results among methods. GSI derived allocation estimates were assumed to be the true stock composition of commercial harvests for all analyses reported here.

Several methods for inseason stock allocation were explored using a hindcasting approach with historical fishery-specific GSI data. Stock compositions for each fishery were first lagged by one year and a 3-, 5-, and 10-year rolling average applied. An exponential smoothing approach was also explored by following a similar approach but using 3-, 5-, and 10-year sliding windows. Simulated stock compositions were applied to the commercial harvests for each year and fishery to produce inseason stock-specific harvest estimates. Performance of alternative stock allocation methods were assessed using CV against realized GSI estimates. For each year, the alternative allocation method for each stock and fishery with the lowest average CV score over the previous three years was chosen for stock allocation. Stock composition across fisheries were summed to generate annual stock-specific harvest estimates.

An inseason tier-status assessment is annually performed for late-run stock Kenai River sockeye salmon. Historically, the tier status assessment had relied on cumulative catch-per-unit-effort timing curves from the offshore test fish project (OTF) to project the total run to the Kenai River. This method provided unbiased estimates of run timing because performance of this fishery is largely independent of management actions. In 2024, the OTF project was cut due to budget issues which required other methods to be explored for the inseason projection. Inriver run timing curves were assessed using historical total run data and were found to provide reliable total run projection estimates within the scope of run tier designations.

Stock-specific inriver run timing models spanning years 2000 to 2023 were evaluated to project the total run of sockeye salmon to the Kenai River. Projection model performance was assessed using the mean arc-tangent absolute percent error (MAAPE) between the projected daily total run estimates and actual runs up to the date the projection was run. The top three models with the lowest MAAPE were selected for each stock and a weighted hybrid model approach was applied. Model weights were assigned based on the running MAAPE of each selected model, with a lower MAAPE receiving a greater weight towards the final projection estimate.

# Results

### Age Allocation Performance

Since 2017, the age allocation model has achieved an average CV score of 28.5 across all fisheries, stocks, and years. Precision was highest for the Susitna (CV = 22.3) and Other (CV = 23.31) stocks but lowest for the Crescent (CV=45.2), Kasilof (CV = 29.3) and Fish Creek (CV = 29.5) stocks. The Central District Drift (CV = 19.1) and Westside fisheries (CV = 24.3) achieved the highest average precision. No linear trends were detected in the precision of the age allocation model for each fishery and stock across individual time series. The age allocation model has had an average absolute error in estimating the commercial harvest of Kenai and Kasilof stocks of 41,900 (range: -252,700 to 96,000) and 45,800 (range: -187,000 to 321,600) fish respectively.

```{r, echo=F, message=FALSE, warning=F, include=F}
GSI%>%left_join(AgeAllocation)%>%left_join(Harvest.Sum)%>%
  mutate(True.Harvest=Comp*Harvest)%>%
  filter(Year>2016)%>%
  filter(!Comp%in%NA)%>%
  select(1:3,Allocation,True.Harvest)%>%
  rowwise()%>%
  mutate(SD=sd(Allocation:True.Harvest),
         Mean=mean(Allocation:True.Harvest),
         CV=(SD/Mean)*100)%>%
  select(Year,Fishery,Stock,CV)%>%
  group_by(Fishery)%>%
  summarize(CV=mean(CV,na.rm=T))


GSI%>%left_join(AgeAllocation)%>%left_join(Harvest.Sum)%>%
  mutate(True.Harvest=Comp*Harvest)%>%
  filter(Year>2016)%>%
  filter(!Comp%in%NA)%>%
  mutate(Diff=abs(Allocation-True.Harvest))%>%
  group_by(Stock)%>%
  summarize(Mean=mean(Diff), min=min(Diff), max=max(Diff))

```

Table 3.- Average precision, measured by coefficient of variation, between the true stock-specific harvest estimates and those generated with age and GSI allocation methods for each stock and fishery, 2017 to 2024. The mean absolute difference, in terms of fish, is indicated in the difference column.

```{r, echo=F, message=FALSE, warning=F}

By.Stock.Fishery<-GSI%>%left_join(AgeAllocation)%>%left_join(Harvest.Sum)%>%
  mutate(True.Harvest=Comp*Harvest)%>%
  filter(Year>2016)%>%
  filter(!Comp%in%NA)%>%
  select(1:3,Allocation,True.Harvest)%>%
  rowwise()%>%
  mutate(SD=sd(Allocation:True.Harvest),
         Mean=mean(Allocation:True.Harvest),
         CV=(SD/Mean)*100)%>%
  select(Fishery,Stock,CV)%>%
  group_by(Stock, Fishery)%>%
  summarize(CV=mean(CV, na.rm = T))
  
  
By.Stock.Fishery%>%
  rbind(GSI%>%left_join(AgeAllocation)%>%left_join(Harvest.Sum)%>%
  mutate(True.Harvest=Comp*Harvest)%>%
  filter(Year>2016)%>%
  filter(!Comp%in%NA)%>%
  select(1:3,Allocation,True.Harvest)%>%
  rowwise()%>%
  mutate(SD=sd(Allocation:True.Harvest),
         Mean=mean(Allocation:True.Harvest),
         CV=(SD/Mean)*100)%>%
  select(Fishery,Stock,CV)%>%
  group_by(Fishery)%>%
  summarize(CV=mean(CV, na.rm = T))%>%
  mutate(Stock="Fishery Average"),
  
  GSI%>%left_join(AgeAllocation)%>%left_join(Harvest.Sum)%>%
  mutate(True.Harvest=Comp*Harvest)%>%
  filter(Year>2016)%>%
  filter(!Comp%in%NA)%>%
  select(1:3,Allocation,True.Harvest)%>%
  rowwise()%>%
  mutate(SD=sd(Allocation:True.Harvest),
         Mean=mean(Allocation:True.Harvest),
         CV=(SD/Mean)*100)%>%
  select(Fishery,Stock,CV)%>%
  group_by(Stock)%>%
  summarize(CV=mean(CV, na.rm = T))%>%mutate(Fishery="Stock Average"))%>%
  
  pivot_wider(values_from = CV, names_from=Fishery)%>%
  flextable()%>%
  theme_apa()%>%
  line_spacing(space = 1)%>%
  hline(i=6)%>%
  autofit()
 


```

### GSI Allocation Performance

The GSI allocation method produced generally similar post-season stock specific harvest estimates as the age allocation method for most stocks and years (Figure 3). Precision of stock specific harvest estimates across all fisheries and stocks were not statistically different among allocation methods (P\>0.05) (Table 4).

```{r, echo=F, message=FALSE, warning=F,include=F}

Allocation.Summary<-GSI%>%left_join(AgeAllocation)%>%left_join(Harvest.Sum)%>%
  mutate(True.Harvest=Comp*Harvest)%>%
  filter(Year>2016)%>%
  filter(!Comp%in%NA)%>%
  select(1:3,Allocation,True.Harvest)%>%
  rowwise()%>%
  mutate(SD=sd(Allocation:True.Harvest),
         Mean=mean(Allocation:True.Harvest),
         CV=(SD/Mean)*100)%>%
  rename("Total"=Allocation)%>%
  mutate(Method="Age Allocation")




GSIMeans<-GSI%>%group_by(Fishery,Stock)%>%
  mutate(Lagged=lag(Comp,1),
    Roll3=rollmean(Lagged,k=3, fill=NA, na.rm=T, align="right"),
         Roll5=rollmean(Lagged,k=5, fill=NA, na.rm=T, align="right"),
         Roll10=rollmean(Lagged,k=10, fill=NA, na.rm=T, align="right"))%>%
  group_by(Fishery, Stock)%>%
  fill(c(Roll3,Roll5,Roll10),.direction = "down")%>%
  left_join(Harvest.Sum)%>%
  mutate(Harvest=ifelse(Harvest%in%NA,0,Harvest))%>%
  mutate(True.Harvest=Comp*Harvest,
         RollHarvest3=Roll3*Harvest,
         RollHarvest5=Roll5*Harvest,
         RollHarvest10=Roll10*Harvest)

################################################################################
# Using an exponential smoothing approach with varying window widths
  
GSIEXPO<-GSI%>%group_by(Stock, Fishery)%>%
  mutate(Lagged=lag(Comp, 1))%>%
  filter(!Lagged%in%NA)%>%
  group_by(Stock, Fishery)%>%
  mutate(Smoothed3=EMA(Lagged, n=3),
         Smoothed5=EMA(Lagged, n=5),
         Smoothed10=EMA(Lagged, n=10))%>%
  left_join(Harvest.Sum)%>%
  mutate(Harvest=ifelse(Harvest%in%NA,0,Harvest))%>%
  mutate(True.Harvest=Comp*Harvest,
        Smoothed3Harvest=Smoothed3*Harvest,
         Smoothed5Harvest=Smoothed5*Harvest,
         Smoothed10Harvest=Smoothed10*Harvest)

# Aggregating everything 

MethodsAgg<-rbind(GSIMeans%>%select(1:3,10:13)%>%rename("Roll 3"=RollHarvest3, "Roll 5"=RollHarvest5,"Roll 10"=RollHarvest10)%>%pivot_longer(5:7,names_to = "Method",values_to = "Total"),
                  GSIEXPO%>%select(1:3,10:13)%>%rename("Exp 3"=Smoothed3Harvest, "Expo 5"=Smoothed5Harvest,"Expo 10"=Smoothed10Harvest)%>%pivot_longer(5:7,names_to = "Method",values_to = "Total"))%>%
  
  select(Year, Fishery, Stock, Method, True.Harvest, Total)%>%
  
  ungroup()%>%
  mutate(Mean=rowMeans(across(c(True.Harvest,Total))))%>% ## Estimating precision
  rowwise()%>%
  mutate(SD=sd(c_across(c(True.Harvest,Total))), CV=(SD/Mean))%>%
  filter(!CV%in%NA)%>%
  
  group_by(Stock,Fishery,Method)%>%# Lagging to get prior performance for selections
  mutate(LagCV=lag(CV,n=1))%>%
  
  
  group_by(Stock, Fishery, Method)%>% # Down filling recent performance
  fill(LagCV, .direction = "down")%>%
  
  group_by(Stock, Fishery, Method)%>%
  mutate(CVRoll=rollmean(LagCV, k=3, fill=NA, align = "right", na.rm=T))%>%# Select the lowest average CV over the last three years
  
  group_by(Stock, Fishery, Method)%>%
  fill(CVRoll, .direction = "down")%>%
  filter(!CVRoll%in%NA)%>%
  
  arrange(Year, Fishery, Stock, Method)%>%
  group_by(Year, Stock, Fishery)%>%
  mutate(Selected=ifelse(CVRoll==min(CVRoll,na.exclude=T),"Selected","Not Selected"))



```

```{r, echo=F, message=FALSE, warning=F,fig.height=10}

MethodsAgg%>%select(Year:Total,Selected)%>%
  filter(Selected%in%"Selected")%>%group_by(Year, Stock)%>%summarize(EstimatedHarvest=sum(Total), TrueHarvest=sum(unique(True.Harvest)))%>%mutate(Method="GSI Allocation")%>%
  rbind(AgeAllocation%>%group_by(Year, Stock)%>%summarize(EstimatedHarvest=sum(Allocation, na.rm=T), Method="Age Allocation", Total=NA))%>%
  
  ggplot()+
  geom_bar(aes(Year, TrueHarvest),stat="identity")+
  geom_point(aes(Year, EstimatedHarvest, color=Method), size=3)+
  facet_grid(Stock~.,scales="free")+
  theme_bw()+
   scale_y_continuous(labels = comma)+
  xlab("")+
  ylab("Harvest")+
  theme(text = element_text(family = "serif"))+
  annotate(geom = 'rect', xmin = 2016.5, xmax = 2025, ymin= 0, ymax= Inf,
               fill = 'grey20', alpha = 0.1)


```

Figure 3.- Stock-specific commercial harvest estimates by stock, year, and allocation method. The grey shaded region represents the time frame for which age allocation model results are available.

Table 4.- Average precision, measured by coefficient of variation between annual stock-specific harvest estimates generated with GSI and age allocation methods relative to actual stock-specific harvest estimates, across all fisheries and stocks, 2017 to 2024. The mean absolute difference across all fisheries for each stock and allocation method is indicated in the "Difference" column.

```{r, echo=F, message=FALSE, warning=F}

MethodsAgg%>%select(Year:Total,Selected)%>%
  filter(Selected%in%"Selected")%>%group_by(Year, Stock)%>%summarize(EstimatedHarvest=sum(Total), TrueHarvest=sum(unique(True.Harvest)))%>%mutate(Method="GSI Allocation")%>%
  rbind(AgeAllocation%>%group_by(Year, Stock)%>%summarize(EstimatedHarvest=sum(Allocation, na.rm=T), Method="Age Allocation"))%>%
  filter(Year>2016)%>%
  group_by(Year, Stock)%>%
  fill(TrueHarvest,.direction = "down")%>%
  ungroup()%>%
  mutate(Mean=rowMeans(across(c(EstimatedHarvest,TrueHarvest))))%>% ## Estimating precision
  rowwise()%>%
  mutate(SD=sd(c_across(c(EstimatedHarvest,TrueHarvest))), CV=(SD/Mean), Difference=abs(TrueHarvest-EstimatedHarvest))%>%
  group_by(Stock, Method)%>%summarize(CV=mean(CV), Difference=mean(Difference))%>%
  flextable()%>%
  theme_apa()%>%
  merge_v(j=1)%>%
  valign(j=1:2,valign = "top")%>%
  line_spacing()%>%
  autofit()

Test<-MethodsAgg%>%select(Year:Total,Selected)%>%
  filter(Selected%in%"Selected")%>%group_by(Year, Stock)%>%summarize(EstimatedHarvest=sum(Total), TrueHarvest=sum(unique(True.Harvest)))%>%mutate(Method="GSI Allocation")%>%
  rbind(AgeAllocation%>%group_by(Year, Stock)%>%summarize(EstimatedHarvest=sum(Allocation, na.rm=T), Method="Age Allocation"))%>%
  filter(Year>2016)%>%
  group_by(Year, Stock)%>%
  fill(TrueHarvest,.direction = "down")%>%
  ungroup()%>%
  mutate(Mean=rowMeans(across(c(EstimatedHarvest,TrueHarvest))))%>% ## Estimating precision
  rowwise()%>%
  mutate(SD=sd(c_across(c(EstimatedHarvest,TrueHarvest))), CV=(SD/Mean), Difference=abs(TrueHarvest-EstimatedHarvest))

```

### Inseason Run Tier Assessment Performance

The GSI allocation method produced a somewhat similar total run timing curve for late-run Kenai River sockeye salmon as did with age allocation. Total run timing varied by one-day, with the age allocation occurring July 20th and the GSI alternative on July 19th (Figure 5).

On July 23, 2024 the department projected total run of 3.55 million sockeye salmon to the Kenai River using the age allocation model. This projected total run maintained the forecast middle-tier status (2.3 to 4.6 million). The realized total run for late-run Kenai River sockeye salmon in 2024 was 3.77 million fish (Table 5; Figure 6). The GSI allocation method projected a total run for late-run Kenai River sockeye salmon of 5.23 million fish, which would have resulted in an upper-tier status change (Table 5).

```{r, echo=F, message=FALSE, warning=F, include=F}
# Importing Timing Data
Sonar<-read.csv(file("C:/Users/kpgatt/OneDrive - State of Alaska/Documents/GitHub/Age-Allocation-Assessment/Data/KeKa_Hist_Sonar.csv"))%>%
  mutate(Date=as.Date(Date, format="%m/%d"))%>%
  mutate(Day=day(Date), Month=month(Date))%>%
 mutate(Date=make_date(Year, day=Day, month=Month))%>%
  filter(River%in%"Kenai")

Timing<-Sonar%>%
  filter(Year>=2000)%>%
  group_by(River,Year)%>%
  mutate(Timing=cumsum(Daily.Count)/max(cumsum(Daily.Count)),
                                Date=as.Date(Date,format="%d-%b"))%>%
  select(-Daily.Count)%>%
  group_by(River)%>%
  complete(Year,Date)%>%
  group_by(River,Year)%>%
  fill(Timing,.direction = "updown")%>%
  rename(Stock=River)%>%
  mutate(Date=make_date(year=2024, day=Day, month=Month))%>%
  select(-c(Day, Month, Stock))


#Importing unallocated total run Tracking estimates
TRUnallocated<-read.csv(file("C:/Users/kpgatt/OneDrive - State of Alaska/Documents/GitHub/Age-Allocation-Assessment/Data/TotalRunUnallocated.csv"))%>%
  filter(!Fishery.Project%in%c("Crescent Escapement", "Fish Creek Escapement","Kasilof River Escapement", "Susitna Escapement", "Kasilof Personal Use Gillnet", "Other", "Fish Creek Personal Use", "Kasilof Personal Use Dipnet","Kasilof Sport"))%>%
  mutate(Fishery.Project=ifelse(Fishery.Project%in%c("Central District Drift - State Waters","UCI EEZ" ),"Central District Drift",
         ifelse(Fishery.Project%in%c("Northern District Set Net Fishery - Eastern Subdistrict","Northern District Set Net Fishery - General Subdistrict"),"Northern District",
                ifelse(Fishery.Project%in%c("Kasilof Section Set Net Fishery","Kenai Section Set Net Fishery"),"ESSN",
                       ifelse(Fishery.Project%in%"Western Subdistrict Set Net Fishery","Westside",Fishery.Project)))))

# Reformatting GSI Data
ROLL<-GSIMeans%>%filter(Year==2024)%>%select(Fishery,Stock,Roll3,Roll5,Roll10)%>%filter(Stock%in%"Kenai")%>%rename("Fishery.Project"=Fishery)%>%ungroup()%>%select(-Stock)%>%
  pivot_longer(2:4,values_to = "Composition",names_to = "Method")

EXP<-GSIEXPO%>%filter(Year==2024)%>%select(Fishery,Stock,Smoothed3,Smoothed5,Smoothed10)%>%filter(Stock%in%"Kenai")%>%rename("Fishery.Project"=Fishery)%>%ungroup()%>%select(-Stock)%>%
  pivot_longer(2:4,values_to = "Composition",names_to = "Method")

Methods<-rbind(ROLL,EXP)

Comps<-MethodsAgg%>%filter(Year==2024 & Selected%in%"Selected" & Stock%in%"Kenai")%>%ungroup()%>%select(Fishery,Method)%>%rename("Fishery.Project"=Fishery)%>%
  mutate(Method=recode(Method,"Roll 3"="Roll3", 
                                          "Roll 5"="Roll5", 
                                           "Roll 10"="Roll10", 
                                           "Expo 3" ="Smoothed3", 
                                           "Expo 5" ="Smoothed5",
                                           "Expo 10" ="Smoothed10"))%>%
  left_join(Methods) 


# Apply stock comps of Kenai fish to commercial harvest but only after July 1
CommTR<-TRUnallocated%>%filter(Fate%in%"Commercial Harvest")%>%
  left_join(Comps)%>%
  mutate(Date=as.Date(Date,format="%m/%d/%Y"))%>%
  
  #mutate(Condition=ifelse(Date<as.Date("2024-07-20",format="%Y-%m-%d"),"yes","no"))%>%
  #mutate(Composition=ifelse(Condition%in%"yes",Composition*.6,Composition))%>%
  
  mutate(Season.Total=Season.Total*Composition)%>%
  group_by(Date)%>%summarize(Total=sum(Season.Total,na.rm=T))%>%
  mutate(Fate="Commercial Harvest")

ALt.TR<-CommTR%>%select(-c(Total,Fate))%>%left_join(
TRUnallocated%>%mutate(Date=as.Date(Date,format="%m/%d/%Y"))%>%filter(!Fate%in%"Commercial Harvest")%>%group_by(Date)%>%summarize(Total=sum(Season.Total))%>%mutate(Fate="Other"))%>%
  rbind(CommTR)%>%group_by(Date)%>%summarize(Total=sum(Total))%>%mutate(Method="GSI Allocation")
  

# Bind to age allocation results
Inseason.Results<-read.csv(file("C:/Users/kpgatt/OneDrive - State of Alaska/Documents/GitHub/Age-Allocation-Assessment/Data/Final.Inseason.Results.csv"))%>%filter(Stock%in%"Kenai")%>%group_by(Date)%>%summarize(Total=sum(UCI.Total))%>%mutate(Method="Age Allocation")%>%mutate(Date=as.Date(Date,format="%Y-%m-%d"))


Combined<-rbind(ALt.TR,Inseason.Results)

# Running projections
Test.1<-Timing%>%
  left_join(Combined)%>%
              mutate(Projection=Total/Timing)%>% #generating daily projection estimates
  filter(Date%in%"2024-07-23")%>% #Filtering to projection date
  ungroup()%>%
  select(Year, Method, Projection)%>%
  left_join(Timing)%>% #combining timing data to estimate daily total run estimates
  ungroup()%>%
  mutate(Daily=Timing*Projection)


Test.2<-Test.1%>%
  filter(Date<as.Date("2024-07-23", format="%Y-%m-%d"))%>%# Filter to the projection date
  left_join(Combined)%>%# Combining true counts
  group_by(Method,Year)%>%summarize(MAAPE=mean(maape(Total,Daily)))%>%
  group_by(Method)%>%slice_min(order_by=MAAPE,n=3)%>%select(Method,Year,MAAPE)


```

```{r, echo=F, message=FALSE, warning=F}
Combined%>%
  filter(Date<as.Date("2024-07-24", format="%Y-%m-%d"))%>%
  ggplot()+
  geom_line(aes(Date,Total, color=Method), size=1, alpha=.5)+
  scale_y_continuous(label=comma)+
  theme_bw()+
  ylab("Total run")+
  theme(text = element_text(family = "serif"))

```

Figure 5.- Daily total run estimates for late-run Kenai River stock sockeye salmon by stock apportionment method, 2024.

Table 5.- Top selected run timing models used the inseason run tier assessment by allocation method, 2024.

```{r, echo=F, message=FALSE, warning=F}

Test.2%>%
  left_join(Test.1%>%filter(Date%in%"2024-07-23")%>%select(Method,Year,Projection))%>%
  mutate(Inv.Weight=1/MAAPE)%>%group_by(Method)%>%
  mutate(Weight=Inv.Weight/sum(Inv.Weight),Weighted.Projection=Projection*Weight,Total=sum(Weighted.Projection))%>%
  select(-Inv.Weight)%>%
  mutate(Year=as.factor(Year))%>%
  flextable()%>%
  line_spacing(space = 1)%>%
  theme_apa()%>%
  merge_v(j=c(1,7))%>%
  valign(valign = "top", j=1)%>%
  valign(valign = "bottom", j=7)%>%
  hline(i=3)%>%
  set_header_labels(Weighted.Projection="Weighted Projection")%>%
   line_spacing(space=1)%>%
  autofit()



```

```{r, echo=F, message=FALSE, warning=F, fig.height=8}


Test.1%>%
  left_join(Test.2%>%mutate(Select=Year))%>%
  left_join(Combined%>%
              filter(Date<as.Date("2024-07-23", format="%Y-%m-%d")))%>%# Combining true counts
  ggplot()+
  geom_line(aes(Date,Daily,group=Year),size=1.5)+
  facet_grid(Method~.,scales = "free")+
  gghighlight(Year==Select ,calculate_per_facet = TRUE, use_direct_label = FALSE,
              unhighlighted_params = list(linewidth = 1, colour = alpha("grey", 0.7)))+
  geom_line(aes(Date,Total),color=2,size=1.5)+
  theme_bw()+
  scale_y_continuous(label=comma)+
  ylab("Total Run Size")+
  theme(text = element_text(family = "serif"))


```

Figure 6.- Projected cumulative total run estimates for the top three selected run timing models (black lines) for each stock allocation method relative to the observed cumulative total run estimated derived from each allocation method.

# Recommendations

Overall, the age allocation model performed relatively well at estimating stock-specific harvest estimates. This was especially the case for the Kenai stock. However, the age allocation model struggled to allocate less represented stocks in several fisheries because of the strong influence of the Kenai stock on allocations.

On average, GSI allocation yielded marginally less precise post-season stock-specific harvest estimates than did the GSI alternative for primary stocks (Kenai and Kasilof) but were not statistically different among allocation methods.

The GSI alternative method of stock allocations projected a different mid-season tier designation compared to the age allocation model. This result was somewhat expected, as the GSI method presented here assumes a static stock composition within each fishery throughout the entire season. This static approach tends to overestimate Kenai contributions early in the season, before the peak of the stock’s run timing, resulting in inflated total run projections. The GSI method used here is a broad-stroke approach based on aggregated annual GSI estimates and does not utilize the full set of available GSI data. This limits its temporal resolution. For instance, in 2023, GSI estimates from corridor-only fishing periods showed that the Kenai contribution to the Central District Drift harvest increased from 33% in the first temporal stratum (6/19–7/12) to over 65% in the final stratum (7/18–8/2). When temporal variation is incorporated into the GSI model, total run projections align more closely with those produced by the age allocation method (see Appendices 2 through 4).

**Overall, adoption of the GSI allocation approach presents several advantages: it yields similar final total run estimates as the age allocation model, requires far fewer assumptions, and reduces the need for timely in-season age composition data which will allow for re-allocation of resources to other sampling efforts (e.g., Northern District North, Coho sampling). However, refinements are needed before full implementation. First, all historical GSI data should be compiled into a centralized database, rather than using annual averages as done here. Second, GSI estimates for corridor-only and non-corridor harvests should be analyzed separately due to their distinct stock compositions.**

# References

Barclay, A. W. 2020. Compilation (2005–2019) of genetic stock identification estimates of sockeye salmon harvest from sampled Upper Cook Inlet commercial fisheries; Susitna River components reported both separately and combined. Alaska Department of Fish and Game, Division of Commercial Fisheries, Regional Information Report 5J20-02, Anchorage.

Barclay, A. W., and E. L. Chenoweth. 2021. Genetic stock identification of Upper Cook Inlet sockeye salmon harvest, 2020. Alaska Department of Fish and Game, Division of Commercial Fisheries, Regional Information Report No. 5J21-04, Anchorage.

Barclay, A. W. 2024. Genetic stock composition estimates for the Upper Cook Inlet sockeye salmon commercial fishery, 2021–2023. Alaska Department of Fish and Game, Division of Commercial Fisheries, Regional Information Report No. 5J24-02, Anchorage.

Tobias T. M., and T. M. Willette. 2013. An estimate of total return of sockeye salmon to Upper Cook Inlet. Alaska, 1976–2008. Alaska Department of Fish and Game, Division of Commercial Fisheries, Regional Information Report 2A13-02, Anchorage.

# Appendices

Appendix 1.- Aggregated GSI, Harvest, and age allocation results used for analyses.

```{r, echo=F, message=FALSE, warning=F}

datatable(GSI%>%left_join(AgeAllocation)%>%left_join(Harvest.Sum))
  
```

Appendix 2.- Daily total run estimates by stock allocation method assuming a 60% reduction in Kenai GSI estimates prior to July 20th.

```{r, echo=F, message=FALSE, warning=F, include=F}

# Apply stock comps of Kenai fish to commercial harvest but only after July 1
CommTR.0<-TRUnallocated%>%filter(Fate%in%"Commercial Harvest")%>%
  left_join(Comps)%>%
  mutate(Date=as.Date(Date,format="%m/%d/%Y"))%>%
  
  mutate(Condition=ifelse(Date<as.Date("2024-07-20",format="%Y-%m-%d"),"yes","no"))%>%
  mutate(Composition=ifelse(Condition%in%"yes",Composition*.6,Composition))%>%
  
  mutate(Season.Total=Season.Total*Composition)%>%
  group_by(Date)%>%summarize(Total=sum(Season.Total,na.rm=T))%>%
  mutate(Fate="Commercial Harvest")

ALt.TR.0<-CommTR.0%>%select(-c(Total,Fate))%>%left_join(
TRUnallocated%>%mutate(Date=as.Date(Date,format="%m/%d/%Y"))%>%filter(!Fate%in%"Commercial Harvest")%>%group_by(Date)%>%summarize(Total=sum(Season.Total))%>%mutate(Fate="Other"))%>%
  rbind(CommTR.0)%>%group_by(Date)%>%summarize(Total=sum(Total))%>%mutate(Method="GSI Allocation")
  

# Bind to age allocation results
Inseason.Results<-read.csv(file("C:/Users/kpgatt/OneDrive - State of Alaska/Documents/GitHub/Age-Allocation-Assessment/Data/Final.Inseason.Results.csv"))%>%filter(Stock%in%"Kenai")%>%group_by(Date)%>%summarize(Total=sum(UCI.Total))%>%mutate(Method="Age Allocation")%>%mutate(Date=as.Date(Date,format="%Y-%m-%d"))


Combined.0<-rbind(ALt.TR.0,Inseason.Results)

# Running projections
Test.1.0<-Timing%>%
  left_join(Combined.0)%>%
              mutate(Projection=Total/Timing)%>% #generating daily projection estimates
  filter(Date%in%"2024-07-23")%>% #Filtering to projection date
  ungroup()%>%
  select(Year, Method, Projection)%>%
  left_join(Timing)%>% #combining timing data to estimate daily total run estimates
  ungroup()%>%
  mutate(Daily=Timing*Projection)


Test.2.0<-Test.1.0%>%
  filter(Date<as.Date("2024-07-23", format="%Y-%m-%d"))%>%# Filter to the projection date
  left_join(Combined.0)%>%# Combining true counts
  group_by(Method,Year)%>%summarize(MAAPE=mean(maape(Total,Daily)))%>%
  group_by(Method)%>%slice_min(order_by=MAAPE,n=3)%>%select(Method,Year,MAAPE)



```

```{r, echo=F, message=FALSE, warning=F}

Combined.0%>%
  filter(Date<as.Date("2024-07-24", format="%Y-%m-%d"))%>%
  ggplot()+
  geom_line(aes(Date,Total, color=Method), size=1, alpha=.5)+
  scale_y_continuous(label=comma)+
  theme_bw()+
  ylab("Total run")+
  theme(text = element_text(family = "serif"))
  

```

Appendix 3.- Projected total run estimates by stock allocation method assuming a 60% reduction in Kenai GSI estimates prior to July 20th.

```{r, echo=F, message=FALSE, warning=F}

Test.2.0%>%
  left_join(Test.1.0%>%filter(Date%in%"2024-07-23")%>%select(Method,Year,Projection))%>%
  mutate(Inv.Weight=1/MAAPE)%>%group_by(Method)%>%
  mutate(Weight=Inv.Weight/sum(Inv.Weight),Weighted.Projection=Projection*Weight,Total=sum(Weighted.Projection))%>%
  select(-Inv.Weight)%>%
  mutate(Year=as.factor(Year))%>%
  flextable()%>%
  line_spacing(space = 1)%>%
  theme_apa()%>%
  merge_v(j=c(1,7))%>%
  valign(valign = "top", j=1)%>%
  valign(valign = "bottom", j=7)%>%
  hline(i=3)%>%
  set_header_labels(Weighted.Projection="Weighted Projection")%>%
  line_spacing(space=1)%>%
  autofit()


```

Appendix 4.- Projected cumulative total run estimates for the top three selected run timing models (black lines) for each stock allocation method relative to the observed cumulative total run derived from each allocation method. The GSI allocation method assumes a 60% reduction in Kenai GSI estimates prior to July 20th.

```{r, echo=F, message=FALSE, warning=F}


Test.1.0%>%
  left_join(Test.2.0%>%mutate(Select=Year))%>%
  left_join(Combined.0%>%
              filter(Date<as.Date("2024-07-23", format="%Y-%m-%d")))%>%# Combining true counts
  ggplot()+
  geom_line(aes(Date,Daily,group=Year),size=1.5)+
  facet_grid(Method~.,scales = "free")+
  gghighlight(Year==Select ,calculate_per_facet = TRUE, use_direct_label = FALSE,
              unhighlighted_params = list(linewidth = 1, colour = alpha("grey", 0.7)))+
  geom_line(aes(Date,Total),color=2,size=1.5)+
  theme_bw()+
  scale_y_continuous(label=comma)+
  ylab("Total Run Size")+
  theme(text = element_text(family = "serif"))

```
